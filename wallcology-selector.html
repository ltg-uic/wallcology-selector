<link href="./bower_components/polymer/polymer.html" rel="import">
<link href="./bower_components/paper-styles/paper-styles.html" rel="import">
<link href="./bower_components/paper-styles/color.html" rel="import">


<link href="./bower_components/paper-button/paper-button.html" rel="import">
<link href="./bower_components/paper-icon-button/paper-icon-button.html" rel="import">
<link href="./bower_components/iron-flex-layout/iron-flex-layout.html" rel="import">

<script type="text/javascript" src="./bower_components/predicates.js/browser/predicates.js"></script>


<!--<link href="../polymer/polymer.html" rel="import">-->
<!--<link href="../paper-styles/paper-styles.html" rel="import">-->
<!--<link href="../paper-styles/color.html" rel="import">-->


<!--<link href="../paper-button/paper-button.html" rel="import">-->
<!--<link href="../paper-icon-button/paper-icon-button.html" rel="import">-->

<!--<script type="text/javascript" src="predicates.js"></script>-->
<dom-module id="wallcology-selector">
    <template id="layout">
        <style>


            :host {

            }

            .pink {
                background-color: var(--paper-pink-500);
            }

            .yellow {
                background-color: var(--paper-yellow-500);
            }

            .bug {
                --iron-icon-height: 45px;
                --iron-icon-width: 45px;
            }

            paper-button.colorful {
                border: 1px solid #0e4f69 !important;
                color: white;
                margin: 1px;
                background-color: #135b78 !important;
                /*background: #237599;*/
                /*margin-top: 1px;*/
                font-size: 12px;
                text-transform: none;
            }

            .vcontainer {
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }

            paper-icon-button[toggles].selector {
                margin: 1px;
                padding: 0px;
                height: 45px;
                width: 45px;
            }

            paper-icon-button[toggles].selector > paper-ripple {
                margin: 1px;
                padding: 0px;
                height: 45px;
                width: 45px;
            }

            paper-icon-button[toggles] {
                margin: 1px;
                padding: 0px;
            }

            paper-icon-button[toggles] {
                margin: 1px;
                padding: 0px;
            }

            paper-icon-button[toggles][active] {
                color: orange;
                margin: 1px;
                padding: 0px;
            }

            paper-icon-button[toggles][disabled] {
                margin: 1px;
                padding: 0px;
            }

            .spacer {
                margin: 5px;
            }

            .selector-container {
                /*position: relative;*/
                padding: 0px 0px;

                margin: 2px auto 2px auto;
                /*background-color: #e3e3e3;*/
                /*height: 60px;*/
                -webkit-box-shadow: inset 0 3px 9px rgba(0, 0, 0, 0.3);
                box-shadow: inset 0 3px 9px rgba(0, 0, 0, 0.3);
                /* border: 1px solid #237599;*/
            }


        </style>

        <div class="selector-container horizontal layout">
            <div class="vcontainer spacer">
                <paper-button class="colorful" on-tap="toggleTapped"><span>{{currentToggle.name}}</span>
                </paper-button>
            </div>
            <div id="key" class="spacer">
                <template id="buttonTemplate" is="dom-repeat" items="{{buttonSelectors}}">
                    <paper-icon-button toggles disabled id="{{index}}" on-tap="buttonTapped" src="{{item.activeUrl}}"
                                       class="bug selector" noink></paper-icon-button>
                </template>
            </div>
        </div>

    </template>
</dom-module>
<script>
    // element registration
    Polymer({
        is: 'wallcology-selector',

        // add properties and methods on the element's prototype
        properties: {
            // declare properties for the element's public API
            selectedItems: {
                type: Array,
                notify: true,
                selectedItems: []
            },
            maxSelections: {
                type: Number,
                notify: true,
                value: 13
            },
            currentToggle: {
                type: Object,
                notify: true,
                value: {}
            },
            toggleSelectors: {
                type: Array,
                notify: true,
                value: [
                    {
                        'items': [
                            0,
                            1,
                            2,
                            3,
                            4,
                            5,
                            6,
                            7,
                            8,
                            9,
                            10,
                            11,
                            12
                        ],
                        'name': 'Habitat 1',
                        'index': 0,
                    },
                    {
                        'items': [
                            0,
                            1,
                            2,
                            3,
                            4,
                            5,
                            6,
                            7,
                            8,
                            9,
                            10,
                            11,
                            12
                        ],
                        'name': 'Habitat 2',
                        'index': 1,
                    },
                    {
                        'items': [
                            0,
                            1,
                            2,
                            3,
                            4,
                            5,
                            6,
                            7,
                            8,
                            9,
                            10,
                            11,
                            12
                        ],
                        'name': 'Habitat 3',
                        'index': 2,
                    },
                    {
                        'items': [
                            0,
                            1,
                            2,
                            3,
                            4,
                            5,
                            6,
                            7,
                            8,
                            9,
                            10,
                            11,
                            12
                        ],
                        'name': 'Habitat 4',
                        'index': 3,
                    }
                ]
            },
            buttonSelectors: {
                type: Array,
                notify: true,
                value: [
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_00.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_00_0.svg',
                        'index': 0,
                        'color': '#FFC91B',
                        'type': 'h'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_01.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_01_0.svg',
                        'index': 1,
                        'color': '#5A6372',
                        'type': 'p'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_02.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_02_0.svg',
                        'index': 2,
                        'color': '#FFDD00',
                        'type': 'h'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_03.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_03_0.svg',
                        'index': 3,
                        'color': '#2C4721',
                        'type': 'p'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_04.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_04_0.svg',

                        'index': 4,
                        'color': '#502B6E',
                        'type': 'r'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_05.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_05_0.svg',
                        'index': 5,
                        'color': '#99cc33',
                        'type': 'r'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_06.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_06_0.svg',
                        'index': 6,
                        'color': '#8975B5',
                        'type': 'h'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_07.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_07_0.svg',
                        'index': 7,
                        'color': '#FAAA19',
                        'type': 'h'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_08.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_08_0.svg',
                        'index': 8,
                        'color': '#899C7C',
                        'type': 'p'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_09.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_09_0.svg',
                        'index': 9,
                        'color': '#4AB6C8',
                        'type': 'r'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_10.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_10_0.svg',
                        'index': 10,
                        'color': '#68734F',
                        'type': 'r'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/env_temp.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/env_temp_0.svg',
                        'index': 11,
                        'color': '#FF5722',
                        'type': 'r'
                    },
                    {
                        'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/env_pipe.svg',
                        'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/env_pipe_0.svg',
                        'index': 12,
                        'color': '#795548',
                        'type': 'r'

                    }
                ]
            },
            debug: {
                type: Boolean,
                value: false
            }
        },
        observers: [
            'selectedItemsChanged(selectedItems.*)',
            'toggleSelectorsChanged(toggleSelectors.*)',
            'buttonSelectorsChanged(buttonSelectors.*)'
        ],
        selectedItemsChanged: function (changeRecord) {
            if (this.debug) {
                console.log('selectedItemsChanged: ', changeRecord);
            }
            if (changeRecord.value !== null && this.selectedItems[0] !== null) {
            }
        },
        buttonSelectorsChanged: function (changeRecord) {
            if (this.debug) {
                console.log('buttonSelectorsChanged: ', changeRecord);
            }

            if (changeRecord.path == 'buttonSelectors.splices') {
                // a user was added or removed
            } else {
                // an individual user or its sub-properties changed
                // check "changeRecord.path" to determine what changed
            }
        },
        toggleSelectorsChanged: function (changeRecord) {
            if (this.debug) {
                console.log('toggleSelectorsChanged: ', changeRecord);
            }
//                console.log('toggle', changeRecord);
            if (this.currentToggle.name === undefined && this.toggleSelectors[0] !== undefined) {
                for (var i = 0; i < this.toggleSelectors.length; i++) {
                    if (this.toggleSelectors[i].index === -1) {
                        this.currentToggle = this.toggleSelectors[i];
                        this.disableButtons(undefined);
                    }
                }
            }
        },
        getAllButtons: function () {
            return Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
        },
        toggleTapped: function (e) {
            if (this.debug) {
                console.log('toggleTapped: ', e);
            }
//                console.log('toggle tapped');
            if (this.currentToggle !== undefined) {

//                    if( this.currentToggle.index === -1) {
//                        this.shift('toggleSelectors');
//                    }

                //clear all the selections
                for (var i = 0; i < this.selectedItems.length; i++) {
                    this.splice('selectedItems', i);
                }
                this.selectedItems = [];
                //clear highlighted
                this.inactivateButtons();


                var previousIndex = this.currentToggle.index;
                var newIndex = previousIndex + 1;

                var nextToggle = this.findToggle(newIndex);

                if (nextToggle !== undefined) {
                    this.currentToggle = nextToggle;
                    this.disableButtons(nextToggle.items);


                } else {
                    //restarts numbering
                    this.currentToggle = this.findToggle(0);
                    this.disableButtons(this.findToggle(0).items);
                }

            }
        },
        inactivateButtons: function () {
            if (this.debug) {
                console.log('inactivateButtons: ');
            }
            var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
            if (buttons !== undefined && buttons[0] !== undefined) {
                for (var i = 0; i < buttons.length; i++) {
                    var b = buttons[i];
                    b.active = false;
                    this.switchIconTo('active', i);
                }
            }
        },
        disableButtons: function (buttonIndexes) {

            if (buttonIndexes === undefined || buttonIndexes.length === 0) {


                //disable all array
                var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
                for (var i = 0; i < buttons.length; i++) {
                    var b = buttons[i];
                    this.switchIconTo('active', i);
                    b.disabled = true;
                }
            } else {
//                    console.log('indexs to disable', buttonIndexes);
                var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
                for (var i = 0; i < buttons.length; i++) {
                    var b = buttons[i];
                    var doesContain = predicates.in(buttonIndexes);
                    var bIndex = parseInt(b.id);
                    var truth = doesContain(bIndex);
                    if (truth) {
                        b.disabled = false;
                    } else {
                        b.disabled = true;
                    }

                }
            }
        },
        buttonTapped: function (e) {
            if (this.debug) {
                console.log('buttonTapped: ', e);
            }
            if (!this.hasMaxSelections()) {
                var selectedItem = e.model.item;

                if (e.currentTarget.active) {
                    //make hightlighted

                    var index = e.model.index;

                    this.switchIconTo('highlighted', index);
                    this.push('selectedItems', selectedItem);
                } else {
                    //make active

                    var index = e.model.index;

                    this.switchIconTo('active', index);
                    this.splice('selectedItems', this.selectedItems.indexOf(selectedItem), 1);
                    console.log('debug');
                }
            } else {
                console.log('TOO MANY SELECTIONS');
                e.currentTarget.active = false;
            }
        },
        switchIconTo: function (state, index) {
            if (this.debug) {
                console.log('switchIconTo: ', state, index);
            }
            var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
            var b = buttons[index];
            if (state === 'active') {
                b.src = this.buttonSelectors[index].activeUrl;
            } else if (state === 'highlighted') {
                b.src = this.buttonSelectors[index].highlightUrl;
            }
        },
        switchToggleAndButtonSelectors: function (toggleIndex, buttonIndexes) {
            if (this.debug) {
                console.log('switchToggleAndButtonSelectors: ', toggleIndex, buttonIndexes);
            }
            //do the toggle
            var toggle = this.findToggle(toggleIndex);
            this.currentToggle = toggle;

            this.disableButtons(this.currentToggle.items);

            //do the buttons
            this.selectedItems = [];

            if (buttonIndexes.length > 0) {
                var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
                for (var i = 0; i < buttons.length; i++) {
                    var b = buttons[i];
                    if (buttonIndexes.lastIndexOf(i) !== -1) {
                        //b.disabled = false;
                        b.active = true;
                        this.push('selectedItems', this.buttonSelectors[i]);
                    } else {
                        b.active = false;
                        //b.disabled = true;
                    }
                }
            }
        },
        hasMaxSelections: function () {
            if (this.debug) {
                console.log('hasMaxSelections:');
            }
            var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
            var active = 0;
            for (var i = 0; i < buttons.length; i++) {
                var b = buttons[i];
                if (b.active) {
                    active++;
                }
            }

            if (active > this.maxSelections) {
                console.log('max selections' + this.maxSelections);
                return true;
            }
            return false;
        },
        findToggle: function (index) {
            if (this.debug) {
                console.log('findToggle:', index);
            }
            for (var i = 0; i < this.toggleSelectors.length; i++) {
                if (index === this.toggleSelectors[i].index) {
                    return this.toggleSelectors[i];
                }
            }
            return undefined;
        },
        ready: function () {
            this.currentToggle = {};
            this.selectedItems = [];
        },
        created: function () {
            if (this.debug) {
                console.log(this.localName + '#' + this.id + ' was created');
            }
        },

        attached: function () {
            if (this.debug) {
                console.log(this.localName + '#' + this.id + ' was attached');
            }
        },

        detached: function () {
            if (this.debug) {
                console.log(this.localName + '#' + this.id + ' was detached');
            }
        },

        attributeChanged: function (name, type) {
            if (this.debug) {
                console.log(this.localName + '#' + this.id + ' attribute ' + name +
                        ' was changed to ' + this.getAttribute(name));
            }
        }
    });
</script>
