<!DOCTYPE html>
<html>
<head>


    <link href="../polymer/polymer.html" rel="import">
    <!--<link href="./styles/app-theme.html" rel="import">-->
    <link href="../paper-styles/paper-styles.html" rel="import">

    <link href="../paper-button/paper-button.html" rel="import">
    <link href="../paper-icon-button/paper-icon-button.html" rel="import">

    <link href="../iron-flex-layout/iron-flex-layout.html" rel="import">

    <script type="text/javascript" src="../predicates.js/browser/predicates.js"></script>


</head>

<dom-module id="wallcology-selector">
    <style>

        :host {

        }

        .pink {
            background-color: var(--paper-pink-500);
        }

        .yellow {
            background-color: var(--paper-yellow-500);
        }

        .bug {
            --iron-icon-height: 45px;
            --iron-icon-width: 45px;
        }

        paper-button.colorful {
            color: white;
            background: #006699;
        }

        .vcontainer {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        }

        paper-icon-button[toggles].selector {
            margin: 0px;
            padding: 0px;
            height: 45px;
            width: 45px;
            border-radius: 20px;
            border: 1px solid white;
        }

        paper-icon-button[toggles] {
            transition: background-color 0.3s;
            border-radius: 20px;
            border: 1px solid white;
        }

        paper-icon-button[toggles][active] {
            background-color: #e8e8e8;
            border-radius: 20px;
            border: 1px solid #e8e8e8;
        }

        paper-icon-button[toggles][disabled] {
            opacity: 0.25;
            border-radius: 20px;
            border: 1px solid white;
        }

        .spacer {
            margin: 5px;
        }

    </style>
    <template id="layout">

        <div class="horizontal layout">
            <div class="vcontainer spacer">
                <paper-button class="colorful" on-tap="toggleTapped"><span>{{currentToggle.name}}</span>
                </paper-button>
            </div>
            <div id="key" class="spacer">
                <template id="buttonTemplate" is="dom-repeat" items="{{buttonSelectors}}">
                    <paper-icon-button toggles disabled id="{{index}}" on-tap="buttonTapped" src="{{item.imgUrl}}"
                                       class="bug selector"></paper-icon-button>
                </template>
            </div>
        </div>

    </template>

    <script>
        // element registration
        Polymer({
            is: 'wallcology-selector',

            // add properties and methods on the element's prototype
            properties: {
                // declare properties for the element's public API
                selectedItems: {
                    type: Array,
                    notify: true,
                },
                maxSelections: {
                    type: Number,
                    notify: true,
                    value: 0
                },
                currentToggle: {
                    type: Object,
                    notify: true,
                    value: {}
                },
                toggleSelectors: {
                    type: Array,
                    notify: true,
                    value: [
                        {
                            "items": [
                                0,
                                1,
                                2,
                                3,
                                4,
                                5,
                                6,
                                7,
                                8,
                                9,
                                10,
                                11,
                                12
                            ],
                            "name": "Habitat 1",
                            "index": 0,
                            "temperature": 0,
                            "pipelength": 0,
                            "brickarea": 0
                        },
                        {
                            "items": [
                                0,
                                1,
                                2,
                                3,
                                4,
                                5,
                                6,
                                7,
                                8,
                                9,
                                10,
                                11,
                                12
                            ],
                            "name": "Habitat 2",
                            "index": 1,
                            "temperature": 0,
                            "pipelength": 0,
                            "brickarea": 0
                        },
                        {
                            "items": [
                                0,
                                1,
                                2,
                                3,
                                4,
                                5,
                                6,
                                7,
                                8,
                                9,
                                10,
                                11,
                                12
                            ],
                            "name": "Habitat 3",
                            "index": 2,
                            "temperature": 0,
                            "pipelength": 0,
                            "brickarea": 0
                        },
                        {
                            "items": [
                                0,
                                1,
                                2,
                                3,
                                4,
                                5,
                                6,
                                7,
                                8,
                                9,
                                10,
                                11,
                                12
                            ],
                            "name": "Habitat 4",
                            "index": 3,
                            "temperature": 0,
                            "pipelength": 0,
                            "brickarea": 0
                        }
                    ]
                },
                buttonSelectors: {
                    type: Array,
                    notify: true,
                    value: [
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/species_00.svg",
                            "index": 0,
                            "color": "#FFC91B"
                        },
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/species_01.svg",
                            "index": 1,
                            "color": "#5A6372"
                        },
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/species_02.svg",
                            "index": 2,
                            "color": "#FFDD00"
                        },
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/species_03.svg",
                            "index": 3,
                            "color": "#2C4721"
                        },
                        {
                            "imgUrl": "http://ltg.cs.uic.edu/WC/icons/species_04.svg",
                            "index": 4,
                            "color": "#502B6E"
                        },
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/species_05.svg",
                            "index": 5,
                            "color": "#99cc33"
                        },
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/species_06.svg",
                            "index": 6,
                            "color": "#8975B5"
                        },
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/species_07.svg",
                            "index": 7,
                            "color": "#FAAA19"
                        },
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/species_08.svg",
                            "index": 8,
                            "color": "#899C7C"
                        },
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/species_09.svg",
                            "index": 9,
                            "color": "#4AB6C8"
                        },
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/species_10.svg",
                            "index": 10,
                            "color": "#68734F"
                        },
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/env_temp.svg",
                            "index": 11,
                            "color": "#FF5722"
                        },
                        {
                            "imgUrl": "https://ltg.cs.uic.edu/WC/icons/env_pipes.svg",
                            "index": 12,
                            "color": "#795548"
                        }

                    ]
                }
            },
            observers: [
                'selectedItemsChanged(selectedItems.*)',
                'toggleSelectorsChanged(toggleSelectors.*)',
                'buttonSelectorsChanged(buttonSelectors.*)'
            ],
            selectedItemsChanged: function (changeRecord) {
                if (changeRecord.value !== null && this.selectedItems[0] !== null) {
                }
            },
            buttonSelectorsChanged: function (changeRecord) {
                if (changeRecord.path == 'buttonSelectors.splices') {
                    // a user was added or removed
                } else {
                    // an individual user or its sub-properties changed
                    // check "changeRecord.path" to determine what changed
                }
            },
            toggleSelectorsChanged: function (changeRecord) {
//                console.log('toggle', changeRecord);
                if (this.currentToggle.name === undefined && this.toggleSelectors[0] !== undefined) {
                    for (var i = 0; i < this.toggleSelectors.length; i++) {
                        if (this.toggleSelectors[i].index === -1) {
                            this.currentToggle = this.toggleSelectors[i];
                            this.disableButtons(undefined);
                        }
                    }
                }
            },
            toggleTapped: function (e) {
//                console.log('toggle tapped');
                if (this.currentToggle !== undefined) {

//                    if( this.currentToggle.index === -1) {
//                        this.shift('toggleSelectors');
//                    }

                    //clear all the selections
                    for (var i = 0; i < this.selectedItems.length; i++) {
                        this.splice('selectedItems', i);
                    }
                    this.selectedItems = [];
                    //clear highlighted
                    this.inactivateButtons();


                    var previousIndex = this.currentToggle.index;
                    var newIndex = previousIndex + 1;

                    var nextToggle = this.findToggle(newIndex);

                    if (nextToggle !== undefined) {
                        this.currentToggle = nextToggle;
                        this.disableButtons(nextToggle.items);


                    } else {
                        //restarts numbering
                        this.currentToggle = this.findToggle(0);
                        this.disableButtons(this.findToggle(0).items);
                    }

                }
            },
            inactivateButtons: function () {
                var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
                for (var i = 0; i < buttons.length; i++) {
                    var b = buttons[i];
                    b.active = false;
                }
            },
            disableButtons: function (buttonIndexes) {
                if (buttonIndexes === undefined || buttonIndexes.length === 0) {
                    //disable all array
                    var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
                    for (var i = 0; i < buttons.length; i++) {
                        var b = buttons[i];
                        b.disabled = true;
                    }
                } else {
//                    console.log('indexs to disable', buttonIndexes);
                    var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
                    for (var i = 0; i < buttons.length; i++) {
                        var b = buttons[i];
                        var doesContain = predicates.in(buttonIndexes);
                        var bIndex = parseInt(b.id);
                        var truth = doesContain(bIndex);
                        if (truth) {
                            b.disabled = false;
                        } else {
                            b.disabled = true;
                        }

                    }
                }
            },
            buttonTapped: function (e) {

                if (!this.hasMaxSelections()) {
                    var selectedItem = e.model.item;

                    if (e.currentTarget.active) {
                        this.push('selectedItems', selectedItem);
                    } else {
                        var index = this.selectedItems.indexOf(selectedItem);
                        this.splice('selectedItems', index, 1);
                        console.log('debug');
                    }
                } else {
                    console.log('TOO MANY SELECTIONS');
                    e.currentTarget.active = false;
                }
            },
            switchToggleAndButtonSelectors: function (toggleIndex, buttonIndexes) {
                //do the toggle
                var toggle = this.findToggle(toggleIndex);
                this.currentToggle = toggle;

                this.disableButtons(this.currentToggle.items);

                //do the buttons
                this.selectedItems = [];

                if (buttonIndexes.length > 0) {
                    var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
                    for (var i = 0; i < buttons.length; i++) {
                        var b = buttons[i];
                        if (buttonIndexes.lastIndexOf(i) !== -1) {
                            //b.disabled = false;
                            b.active = true;
                            this.push('selectedItems', this.buttonSelectors[i]);
                        } else {
                            b.active = false;
                            //b.disabled = true;
                        }
                    }
                }
            },
            hasMaxSelections: function () {

                var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
                var active = 0;
                for (var i = 0; i < buttons.length; i++) {
                    var b = buttons[i];
                    if (b.active) {
                        active++;
                    }
                }

                if (active > this.maxSelections) {
                    console.log('max selections' + this.maxSelections);
                    return true;
                }
                return false;
            },
            findToggle: function (index) {
                for (var i = 0; i < this.toggleSelectors.length; i++) {
                    if (index === this.toggleSelectors[i].index) {
                        return this.toggleSelectors[i];
                    }
                }
                return undefined;
            },

            toUpperCase: function (someString) {
                if (someString !== null) {
                    return someString.toUpperCase();
                }
                return null;
            },
            ready: function () {
                this.selectedItems = [];
                this.buttonSelectors = [];
                this.toggleSelectors = [];
            }
        });
    </script>
</dom-module>
